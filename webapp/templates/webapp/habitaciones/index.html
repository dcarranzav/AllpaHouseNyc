{% extends "cabezal.html" %}
{% load static %}

{% block titulo_pagina %}
<title>Find Your Room | AllpaHouseNYC - Manhattan</title>
{% endblock %}

{% block css_archivos %}
<!-- Litepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

<style>
    :root {
        --color-principal: #8B7355;
        --color-secundario: #6B5842;
        --color-accent: #8B7355;
        --color-fondo: #F5F1E8;
    }

    body {
        background: var(--color-fondo);
    }

    .buscador-section {
        padding: 3rem 0 1rem 0;
    }

    .buscador-form {
        max-width: 1100px;
        margin: 0 auto;
        background: linear-gradient(135deg, #ffffff 0%, #F5F1E8 100%);
        border: 2px solid rgba(232, 220, 196, 0.4);
    }

    .buscador-form .form-control {
        box-shadow: none !important;
    }

    .buscador-form input[readonly] {
        background-color: transparent;
        cursor: pointer;
    }

    .resultado-card {
        border-radius: 1rem;
        overflow: hidden;
    }

    .resultado-card:hover {
        box-shadow: 0 14px 30px rgba(15, 23, 42, .15);
        transform: translateY(-2px);
        transition: 0.2s ease;
    }

    .badge-amenidad {
        border-radius: 999px;
        font-size: .8rem;
    }

    @media (max-width: 768px) {
        .buscador-form {
            border-radius: 1.5rem !important;
        }

        .buscador-form>div {
            border-right: none !important;
            border-bottom: 1px solid #e5e7eb;
        }

        .buscador-form>div:last-child {
            border-bottom: none !important;
        }
    }
</style>
{% endblock %}

{% block contenido_pagina %}

<section class="buscador-section d-flex align-items-center justify-content-center">
    <div class="container text-center">

        <form id="formBuscador"
            class="buscador-form bg-white rounded-pill p-2 shadow d-flex flex-wrap justify-content-between align-items-center">

            <!-- Tipo habitaci√≥n -->
            <div class="d-flex align-items-center px-3 py-2 flex-grow-1 border-end">
                <i class="bi bi-building me-2 text-secondary"></i>

                <select name="tipo_habitacion" class="form-control border-0">
                    <option value="">Tipo de habitaci√≥n / Destino</option>
                    {% for t in tipos_habitacion %}
                    {% if t.EstadoTipoHabitacion %}
                    <option value="{{ t.NombreHabitacion }}">{{ t.NombreHabitacion }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Fechas (Litepicker rango) -->
            <div class="d-flex align-items-center px-3 py-2 flex-grow-1 border-end">
                <i class="bi bi-calendar-event me-2 text-secondary"></i>

                <!-- Input visible que controla el calendar -->
                <input type="text" id="rangoFechas" class="form-control border-0"
                    placeholder="Fecha de entrada ‚Äî Fecha de salida" autocomplete="off" readonly>

                <!-- Inputs ocultos que se mandan al backend -->
                <input type="hidden" name="fecha_entrada" id="fechaEntrada">
                <input type="hidden" name="fecha_salida" id="fechaSalida">
            </div>

            <!-- Capacidad -->
            <div class="d-flex align-items-center px-3 py-2 flex-grow-1 border-end">
                <i class="bi bi-people-fill me-2 text-secondary"></i>
                <input type="number" name="capacidad" min="1" max="99" inputmode="numeric" pattern="[0-9]*"
                    class="form-control border-0" placeholder="Capacidad">
            </div>

            <!-- Precios -->
            <div class="d-flex align-items-center px-3 py-2 flex-grow-1 border-end">
                <i class="bi bi-cash me-2 text-secondary"></i>
                <input type="number" name="precio_min" min="0" step="1" inputmode="numeric" pattern="[0-9]*"
                    class="form-control border-0" placeholder="Precio m√≠nimo">
                <span class="mx-2 text-secondary">‚Äî</span>
                <input type="number" name="precio_max" min="0" step="1" inputmode="numeric" pattern="[0-9]*"
                    class="form-control border-0" placeholder="Precio m√°ximo">
            </div>

            <!-- Bot√≥n -->
            <div class="d-flex align-items-center px-3 py-2">
                <button type="submit" class="btn btn-primary px-4 fw-semibold rounded-pill">
                    <i class="bi bi-search me-2"></i>Buscar
                </button>
            </div>
        </form>

    </div>
</section>

<section class="container py-5">
    <h3 class="fw-bold mb-4">
        <i class="bi bi-building-fill me-2"></i>Available Rooms
    </h3>

    <div id="resultados"></div>

    <div id="loader" class="text-center my-3 d-none">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Cargando m√°s habitaciones...</p>
    </div>

    <div id="finResultados" class="text-muted text-center d-none">
        No hay m√°s resultados.
    </div>
</section>

{% endblock %}

{% block jvscript_archivos_defer %}
<!-- Litepicker JS -->
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

<script>
    let pagina = 1;
    let cargando = false;
    let fin = false;
    let filtros = {};

    // -------------------------
    // RENDER DE LOS CARDS
    // -------------------------
    function renderHabitacion(h) {
        // Amenidades
        let serviciosArray = [];

        if (Array.isArray(h.amenidades)) {
            serviciosArray = h.amenidades;
        } else if (typeof h.amenidades === "string" && h.amenidades.trim() !== "") {
            serviciosArray = h.amenidades.split(",").map(s => s.trim());
        }

        const servicios = serviciosArray
            .map(s => `<span class="badge badge-amenidad bg-primary px-3 py-2 me-1 mb-1">${s}</span>`)
            .join('');

        return `
                <div class="card mb-4 shadow-sm resultado-card">
                    <div class="row g-0">

                        <!-- Imagen -->
                        <div class="col-md-4">
                            <img src="${h.imagen || 'https://via.placeholder.com/400x250?text=Hotel'}"
                                 class="img-fluid rounded-start h-100"
                                 style="object-fit: cover;">
                        </div>

                        <!-- Contenido -->
                        <div class="col-md-8 p-4">

                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h4 class="fw-bold mb-1">${h.nombre}</h4>
                                    <p class="text-muted mb-1">
                                        <i class="bi bi-building"></i> ${h.hotel}
                                    </p>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-geo-alt"></i> ${h.ubicacion}
                                    </p>

                                    <p class="mb-1">
                                        <strong>Tipo:</strong> ${h.tipo_nombre || '‚Äî'}
                                    </p>
                                    <p class="mb-2">
                                        <strong>Capacidad:</strong> ${h.capacidad || '‚Äî'} personas
                                    </p>
                                </div>

                                <div class="text-end">
                                    <span class="text-muted small d-block">Precio por noche</span>
                                    <span class="fw-bold fs-4 text-primary">$${h.precio}</span>
                                </div>
                            </div>

                            <hr>

                            <div class="mb-2">
                                ${servicios || '<span class="text-muted small">Sin amenidades</span>'}
                            </div>

                            <div class="d-flex justify-content-end">
                                <a href="/habitaciones/detalle/${h.id}/"
                                   class="btn btn-primary px-4 fw-semibold rounded-pill">
                                    <i class="bi bi-eye me-2"></i>Ver detalles
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            `;
    }

    // -------------------------
    // CARGAR HABITACIONES (AJAX)
    // -------------------------
    function cargarHabitaciones(reset = false) {
        if (cargando || fin) return;

        cargando = true;
        document.getElementById("loader").classList.remove("d-none");

        if (reset) {
            pagina = 1;
            fin = false;
            document.getElementById("resultados").innerHTML = "";
            document.getElementById("finResultados").classList.add("d-none");
        }

        const params = new URLSearchParams({ ...filtros, page: pagina });

        fetch(`/habitaciones/ajax/?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data.length > 0) {
                    data.data.forEach(h => {
                        document.getElementById("resultados")
                            .insertAdjacentHTML("beforeend", renderHabitacion(h));
                    });

                    pagina++;

                    if ((pagina - 1) * 5 >= data.total) {
                        fin = true;
                        document.getElementById("finResultados").classList.remove("d-none");
                    }
                } else {
                    fin = true;
                    if (pagina === 1) {
                        document.getElementById("resultados").innerHTML =
                            `<p class="text-muted">No se encontraron habitaciones.</p>`;
                    }
                    document.getElementById("finResultados").classList.remove("d-none");
                }
            })
            .catch(err => {
                console.error("Error al cargar habitaciones:", err);
            })
            .finally(() => {
                cargando = false;
                document.getElementById("loader").classList.add("d-none");
            });
    }

    // -------------------------
    // FORMULARIO BUSCADOR
    // -------------------------
    document.getElementById("formBuscador").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;

        filtros = {
            tipo_habitacion: form.tipo_habitacion.value,
            fecha_entrada: form.fecha_entrada.value,
            fecha_salida: form.fecha_salida.value,
            capacidad: form.capacidad.value,
            precio_min: form.precio_min.value,
            precio_max: form.precio_max.value
        };

        // Resetear el estado para permitir nueva b√∫squeda
        fin = false;

        cargarHabitaciones(true);
        fin = false;
        pagina = 1;

        cargarHabitaciones(true);
    });

    // -------------------------
    // SCROLL INFINITO
    // -------------------------
    window.addEventListener("scroll", () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            // Solo cargar m√°s si no hemos llegado al fin
            if (!fin && !cargando) {
                cargarHabitaciones();
            }
        }
    });

    // -------------------------
    // INIT LITEPICKER
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {

        const today = new Date();

        const picker = new Litepicker({
            element: document.getElementById('rangoFechas'),
            singleMode: false,
            numberOfMonths: 2,
            numberOfColumns: 2,
            format: 'YYYY-MM-DD',
            minDate: today,            // üëà NO PERMITE D√çAS ANTERIORES
            autoApply: true,
            tooltipText: {
                one: 'noche',
                other: 'noches'
            },
            tooltipNumber: (totalDays) => {
                return totalDays - 1;   // noches = d√≠as - 1
            },
            lang: 'es-ES',
            setup: (picker) => {
                picker.on('selected', (date1, date2) => {
                    const f1 = date1 ? date1.format('YYYY-MM-DD') : '';
                    const f2 = date2 ? date2.format('YYYY-MM-DD') : '';

                    document.getElementById('fechaEntrada').value = f1;
                    document.getElementById('fechaSalida').value = f2;

                    if (f1 && f2) {
                        document.getElementById('rangoFechas').value = `${f1} ‚Üí ${f2}`;
                    } else if (f1) {
                        document.getElementById('rangoFechas').value = f1;
                    } else {
                        document.getElementById('rangoFechas').value = '';
                    }
                });
            }
        });

        // Primera carga de resultados sin filtros
        cargarHabitaciones(true);

        // -------------------------
        // VALIDACI√ìN DE CAMPOS NUM√âRICOS
        // -------------------------
        // Prevenir caracteres no num√©ricos en campos de precio y capacidad
        const camposNumericos = document.querySelectorAll('input[name="precio_min"], input[name="precio_max"], input[name="capacidad"]');

        camposNumericos.forEach(input => {
            // Prevenir teclas no num√©ricas
            input.addEventListener('keydown', (e) => {
                // Permitir: backspace, delete, tab, escape, enter, home, end, flechas
                const permitidos = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'Home', 'End', 'ArrowLeft', 'ArrowRight'];

                // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase())) {
                    return;
                }

                // Si no es una tecla permitida y no es un n√∫mero (0-9), prevenir
                if (!permitidos.includes(e.key) && (e.key < '0' || e.key > '9')) {
                    e.preventDefault();
                }
            });

            // Prevenir entrada de caracteres no num√©ricos en paste
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text');
                // Solo permitir d√≠gitos
                const numericValue = pasteData.replace(/[^0-9]/g, '');

                // Insertar solo los n√∫meros
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const currentValue = input.value;
                input.value = currentValue.substring(0, start) + numericValue + currentValue.substring(end);

                // Posicionar cursor despu√©s del texto pegado
                const newPosition = start + numericValue.length;
                input.setSelectionRange(newPosition, newPosition);
            });

            // Limpiar cualquier caracter no num√©rico al perder foco
            input.addEventListener('blur', () => {
                input.value = input.value.replace(/[^0-9]/g, '');
            });

            // Prevenir rueda del mouse que cambie el valor (opcional pero recomendado)
            input.addEventListener('wheel', (e) => {
                e.preventDefault();
            });
        });
    });
</script>
{% endblock %}